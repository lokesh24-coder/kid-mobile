<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="My Future">
  <meta name="mobile-web-web-app-capable" content="yes">
  <meta name="theme-color" content="#81D4FA">
  <title>Kid's Future Success Apps</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Open+Sans:wght@400;600;700&family=Poppins:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --accent-color: #81D4FA; /* Sky blue */
      --body-bg-gradient: linear-gradient(135deg, #FFEFBA, #FFFFFF, #B9F6CA);
      --status-bar-height: 40px;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--body-bg-gradient);
      display: flex;
      flex-direction: column; /* Stack status bar and content vertically */
      height: 100vh; /* Make body fill the viewport height */
      width: 100vw; /* Make body fill the viewport width */
      overflow: hidden; /* Hide body scrollbar to prevent double scroll */
      font-family: 'Open Sans', sans-serif;
      color: #333; /* Default text color */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* --- Status Bar --- */
    .status-bar {
      width: 100%;
      height: var(--status-bar-height);
      background: var(--accent-color);
      color: white;
      font-size: 1.1em;
      font-weight: 600;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0 1em;
      box-sizing: border-box;
      z-index: 20; /* Ensure status bar is always on top */
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      font-family: 'Poppins', sans-serif; /* Clean font for status bar */
    }

    .status-bar span {
      margin: 0 0.5em;
    }

    #emotionMeter {
      font-size: 1.4em; /* Make the emoji a bit bigger */
      margin: 0 0.5em;
      transition: transform 0.3s ease-out; /* Smooth scale effect */
      cursor: help; /* Indicate it's interactive/informative */
    }

    #emotionMeter:active {
      transform: scale(1.1);
    }


    /* --- Main App Grid Container --- */
    .app-grid-container {
      flex-grow: 1; /* Takes all remaining vertical space */
      width: 100%;
      display: flex;
      align-items: center; /* Center grid vertically within container */
      justify-content: center; /* Center grid horizontally within container */
      overflow: hidden; /* Important: Prevents grid scrollbar from affecting outer container */
      position: relative; /* For absolute positioning of splash/app overlays */
      /* Wallpaper for the main app grid container */
      background-image: url('https://placehold.co/1200x800/81D4FA/FFFFFF?text=Kids'); /* Placeholder image with "Kids" text */
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    .app-grid {
      display: grid;
      /* Adjusted for better mobile fit: minmax(80px, 1fr) for smaller icons, more columns */
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      grid-gap: 1em; /* Responsive gap */
      padding: 1.5em; /* Responsive padding */
      max-width: 600px; /* Max width for the app grid itself */
      /* Ensure grid doesn't overflow vertically, allowing its own scroll */
      max-height: calc(100vh - var(--status-bar-height) - 1em);
      overflow-y: auto; /* Enable scrolling for the app grid */
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
      background: rgba(255,255,255,0.8); /* Slightly translucent background */
      border-radius: 1.5em;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      box-sizing: border-box; /* Include padding in element size */
      transform: translateX(0); /* Initial state for animation */
      opacity: 1; /* Initial state for animation */
      transition: transform 0.4s ease-out, opacity 0.4s ease-out;
    }

    .app-grid.hidden {
      transform: translateX(-20px); /* Slide slightly left */
      opacity: 0;
      pointer-events: none; /* Disable interaction when hidden */
    }

    /* Custom Scrollbar for app-grid and app-window (Webkit) */
    .app-grid::-webkit-scrollbar,
    .app-content-wrapper::-webkit-scrollbar { /* Apply scrollbar to wrapper now */
      width: 0.6em;
    }

    .app-grid::-webkit-scrollbar-track,
    .app-content-wrapper::-webkit-scrollbar-track {
      background: transparent; /* Match background */
    }

    .app-grid::-webkit-scrollbar-thumb,
    .app-content-wrapper::-webkit-scrollbar-thumb {
      background-color: #A7D9EE; /* Light blue thumb */
      border-radius: 0.6em;
      border: 0.1em solid transparent;
    }

    /* Media Queries for smaller screens */
    @media (max-width: 500px) {
      .app-grid {
        grid-template-columns: repeat(3, 1fr); /* 3 columns on smaller phones */
        padding: 1em; /* Reduced padding */
        grid-gap: 0.8em; /* Reduced gap */
      }
      .app-icon {
        font-size: 2em; /* Adjust icon size for smaller screens */
      }
      .app-name {
        font-size: 0.75em; /* Adjust name size for smaller screens */
      }
    }

    @media (max-width: 350px) {
      .app-grid {
        grid-template-columns: repeat(2, 1fr); /* 2 columns on very small phones */
        padding: 0.8em;
        grid-gap: 0.6em;
      }
      .app-icon {
        font-size: 1.6em;
      }
      .app-name {
        font-size: 0.7em;
      }
    }

    .app {
      background: var(--app-gradient, linear-gradient(135deg, #FFCC80, #FFA726));
      border-radius: 1.4em;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0.6em;
      box-shadow: 0 0.3em 0.8em rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
      position: relative;
      overflow: hidden;
      aspect-ratio: 1 / 1; /* Keep apps square */
      user-select: none; /* Prevent text selection on tap */
      -webkit-tap-highlight-color: transparent; /* Remove tap highlight on iOS */
    }

    .app:active {
      transform: scale(0.95);
    }

    .app-icon {
      font-family: 'Fredoka One', cursive; /* Use for expressive icons */
      font-size: 2.4em;
      margin-bottom: 0.3em; /* Slightly less space for clarity */
      text-shadow: 0 0.1em 0.2em rgba(0,0,0,0.15);
      color: #FFF;
      line-height: 1; /* Ensure icon doesn't add extra height */
    }

    .app-name {
      font-size: 0.85em; /* Slightly larger name */
      text-align: center;
      color: #333;
      font-weight: 700; /* Bolder for prominence */
      line-height: 1.2;
      font-family: 'Open Sans', sans-serif;
      text-shadow: 0 1px 1px rgba(255,255,255,0.5); /* Subtle white shadow for contrast */
    }

    /* Ripple Effect */
    .app .ripple {
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.8);
      animation: ripple-animation 0.6s linear forwards;
      transform: scale(0);
      pointer-events: none;
    }

    @keyframes ripple-animation {
      from { transform: scale(0); opacity: 1; }
      to { transform: scale(2.5); opacity: 0; }
    }

    /* --- Screen Overlays (Splash & App Window) --- */
    .screen-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      background: white;
      z-index: 10;
      overflow: hidden; /* Overlay itself manages content scrolling via wrapper */
      transform: translateX(100%); /* Start off-screen to the right */
      opacity: 0; /* Hidden initially */
      transition: transform 0.4s ease-out, opacity 0.4s ease-out;
      pointer-events: none; /* Disable interaction when hidden */
    }

    .screen-overlay.visible {
      transform: translateX(0);
      opacity: 1;
      pointer-events: auto; /* Enable interaction when visible */
    }

    /* Splash Screen specific styles */
    #splashScreen {
      background: linear-gradient(135deg, #FFEFBA, #FFE082);
      text-align: center;
      cursor: pointer;
      z-index: 30; /* Highest to be on top */
      transform: translateY(0); /* Splash screen starts visible */
      opacity: 1; /* Splash screen starts visible */
      padding: 0; /* No padding on the splash overlay itself */
      transition: opacity 0.5s ease-out, transform 0.5s ease-out, scale 0.5s ease-out; /* Added scale */
    }

    #splashScreen.hidden {
      opacity: 0;
      transform: translateY(-20px) scale(0.95); /* Slide up and slightly scale down */
      pointer-events: none;
    }

    #splashScreen .splash-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      width: 100%;
      padding: 1.5em; /* Add back padding to content within splash */
      box-sizing: border-box;
    }

    #splashScreen h1 {
      font-family: 'Fredoka One', cursive;
      font-size: 3.5em;
      color: #D32F2F;
      margin: 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.15);
    }

    #splashScreen p {
      font-family: 'Open Sans', sans-serif;
      font-size: 1.3em;
      color: #555;
      margin-top: 0.8em;
      font-weight: 600;
    }

    #splashScreen .splash-mobile-icon {
      font-size: 8em;
      margin-top: 2em;
      color: #4CAF50;
      text-shadow: 3px 3px 6px rgba(0,0,0,0.2);
      animation: float 2.5s ease-in-out infinite;
    }

    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-15px); }
      100% { transform: translateY(0px); }
    }

    /* App Window specific styles */
    #appContent {
      background: white;
      z-index: 25; /* On top of app grid, below splash */
      box-shadow: none; /* No shadow when full screen */
    }

    /* Wrapper for app content to handle its own scrolling and padding */
    .app-content-wrapper {
      width: 100%;
      height: 100%;
      overflow-y: auto; /* Allow content to scroll within this wrapper */
      -webkit-overflow-scrolling: touch;
      padding: 1.5em; /* Padding for the content inside the app */
      box-sizing: border-box;
      display: flex; /* Use flex to center title and arrange blocks */
      flex-direction: column;
      align-items: center; /* Center content blocks */
    }

    #appContent h2 {
      font-size: 1.8em;
      margin-top: 1em; /* Adjusted margin to fit within wrapper */
      margin-bottom: 1.2em;
      color: #4A4A4A;
      font-weight: 700;
      font-family: 'Fredoka One', cursive;
      text-align: center; /* Center app titles */
      width: 100%; /* Ensure title takes full width in flex context */
    }

    #appContent p {
      font-size: 1em;
      line-height: 1.6;
      color: #666;
      margin-bottom: 0.8em;
      text-align: left;
      font-family: 'Open Sans', sans-serif;
    }

    .app-content-block {
      background: #F0F8FF;
      border-left: 0.4em solid #6D90F8;
      padding: 1em;
      margin-bottom: 1em;
      border-radius: 0.8em;
      text-align: left;
      box-shadow: 0 0.1em 0.3em rgba(0,0,0,0.1);
      width: 100%; /* Ensure blocks take full width in flex context */
      max-width: 500px; /* Limit block width for readability on larger screens */
      box-sizing: border-box; /* Include padding/border in width */
    }

    .app-content-block strong {
      color: #4A4A4A;
    }

    .app-content-block ul {
      list-style-type: '👉 ';
      padding-left: 1.5em;
      margin-top: 0.6em;
    }

    .app-content-block li {
      margin-bottom: 0.4em;
      padding-left: 0.3em;
    }

    /* --- Parental Gate Overlay (Daily Wisdom) --- */
    .parental-gate-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7); /* Dark semi-transparent background */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 40; /* On top of everything else */
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
    }

    .parental-gate-overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    .parental-gate-box {
      background: #FFF;
      padding: 2em;
      border-radius: 1em;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
      text-align: center;
      max-width: 90%;
      width: 350px;
      display: flex; /* Use flexbox for internal alignment */
      flex-direction: column;
      align-items: center;
    }

    .parental-gate-box h3 {
      font-family: 'Fredoka One', cursive;
      color: #3F51B5;
      font-size: 1.8em;
      margin-top: 0;
      margin-bottom: 1em;
    }

    .parental-gate-box p {
      font-size: 1.1em;
      color: #555;
      margin-bottom: 1.5em;
    }

    /* Styles for the Daily Wisdom content */
    #dailyWisdomText {
      font-family: 'Poppins', sans-serif;
      font-size: 1.3em;
      font-weight: 700;
      color: #00796B; /* Darker teal for wisdom */
      margin-bottom: 0.8em;
    }

    #dailyWisdomChallenge {
      font-size: 1.1em;
      color: #555;
      margin-bottom: 1.5em;
    }

    .parental-gate-box button {
      background: #4CAF50;
      color: white;
      padding: 0.8em 1.5em;
      border: none;
      border-radius: 0.5em;
      font-size: 1.1em;
      cursor: pointer;
      transition: background-color 0.2s ease-out;
      margin-top: 1em; /* Add margin for buttons */
    }

    .parental-gate-box button:hover {
      background-color: #43A047;
    }

    /* New styles for math input and submit button */
    #mathAnswerInput {
      padding: 0.8em;
      border: 2px solid #6D90F8;
      border-radius: 0.5em;
      font-size: 1.1em;
      text-align: center;
      width: 80%;
      max-width: 200px;
      margin-bottom: 1em;
      box-sizing: border-box;
    }

    #submitAnswerBtn {
      background: #6D90F8; /* Blue for submit */
      margin-top: 0; /* Remove top margin as it's part of a group */
    }

    #submitAnswerBtn:hover {
      background-color: #5A7AE2;
    }

    .feedback-message {
      font-size: 1em;
      font-weight: 600;
      margin-top: 0.5em;
      margin-bottom: 1em;
      color: #D32F2F; /* Red for incorrect */
    }

    .feedback-message.correct {
      color: #4CAF50; /* Green for correct */
    }

    /* --- Audio-Visual Storyteller Specific Styles --- */
    .story-content-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      height: 100%; /* Fill parent height */
      width: 100%;
      overflow: hidden; /* Hide overflow from image */
      position: relative;
      background-color: #FFF; /* Ensure background is white */
      border-radius: 1em; /* Rounded corners for the container */
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .story-image {
      max-width: 90%;
      max-height: 50%; /* Adjust height to leave room for text/buttons */
      object-fit: contain; /* Ensure image fits without cropping */
      border-radius: 0.8em;
      margin-bottom: 1em;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .story-text-container {
      background: rgba(255, 255, 255, 0.9); /* Slightly transparent background for readability over image */
      padding: 0.8em 1.2em;
      border-radius: 0.8em;
      max-width: 80%;
      font-size: 1.2em;
      font-weight: 600;
      color: #333;
      margin-top: -1em; /* Pull text up slightly over image */
      position: relative;
      z-index: 1; /* Ensure text is above image slightly for overlap */
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .story-controls {
      display: flex;
      gap: 1.5em;
      margin-top: 1.5em;
      z-index: 1; /* Ensure controls are interactive */
    }

    .story-controls button {
      background: #6D90F8; /* Blue for controls */
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 1.8em;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
      transition: transform 0.2s ease-out, background-color 0.2s ease-out;
    }

    .story-controls button:active {
      transform: scale(0.95);
      background-color: #5A7AE2;
    }

    .story-controls button.play-button {
      background: #4CAF50; /* Green for play */
    }
    .story-controls button.play-button:active {
      background-color: #43A047;
    }

    /* Loading spinner for images */
    .image-loading-spinner {
      border: 4px solid #f3f3f3; /* Light grey */
      border-top: 4px solid #3498db; /* Blue */
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      position: absolute;
      top: 30%; /* Center vertically within story-content-container */
      left: 50%;
      transform: translate(-50%, -50%);
      display: none; /* Hidden by default */
      z-index: 2; /* On top of image */
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="status-bar">
    <span id="emotionMeter" title="Your Current Mood">😊</span> <span id="currentTimeDate"></span>
    <span>✨</span>
  </div>

  <div class="app-grid-container">
    <div id="splashScreen" class="screen-overlay visible">
      <div class="splash-content">
        <h1>Kid's Future!</h1>
        <p>Tap to start your amazing journey!</p>
        <div class="splash-mobile-icon">🚀</div>
      </div>
    </div>

    <div class="app-grid" id="appGrid">
      <div class="app" data-app-key="howToLive" style="--app-gradient: linear-gradient(135deg, #FFD700, #FFC107);">
        <div class="app-icon">💡</div>
        <div class="app-name">Smart Choices</div>
      </div>
      <div class="app" data-app-key="respectFamily" style="--app-gradient: linear-gradient(135deg, #A7D9EE, #6BB9EC);">
        <div class="app-icon">💖</div>
        <div class="app-name">Family Love</div>
      </div>
      <div class="app" data-app-key="careSiblings" style="--app-gradient: linear-gradient(135deg, #FF99CC, #FF66B2);">
        <div class="app-icon">🤝</div>
        <div class="app-name">Teamwork</div>
      </div>
      <div class="app" data-app-key="beSelf" style="--app-gradient: linear-gradient(135deg, #C5E1A5, #8BC34A);">
        <div class="app-icon">🌟</div>
        <div class="app-name">Be Yourself</div>
      </div>
      <div class="app" data-app-key="loveOthers" style="--app-gradient: linear-gradient(135deg, #FFC107, #FF9800);">
        <div class="app-icon">😊</div>
        <div class="app-name">Kindness Map</div>
      </div>
      <div class="app" data-app-key="goalSetting" style="--app-gradient: linear-gradient(135deg, #ADD8E6, #87CEEB);">
        <div class="app-icon">🎯</div>
        <div class="app-name">My Goals</div>
      </div>
      <div class="app" data-app-key="problemSolving" style="--app-gradient: linear-gradient(135deg, #BBDEFB, #64B5F6);">
        <div class="app-icon">🧩</div>
        <div class="app-name">Brain Solver</div>
      </div>
      <div class="app" data-app-key="innovation" style="--app-gradient: linear-gradient(135deg, #FFECB3, #FFD54F);">
        <div class="app-icon">🧪</div>
        <div class="app-name">Innovate Lab</div>
      </div>
      <div class="app" data-app-key="financialLiteracy" style="--app-gradient: linear-gradient(135deg, #C8E6C9, #81C784);">
        <div class="app-icon">💰</div>
        <div class="app-name">Money Smart</div>
      </div>
      <div class="app" data-app-key="communication" style="--app-gradient: linear-gradient(135deg, #FFCDD2, #EF9A9A);">
        <div class="app-icon">💬</div>
        <div class="app-name">Talk It Up!</div>
      </div>
      <div class="app" data-app-key="criticalThinking" style="--app-gradient: linear-gradient(135deg, #B2EBF2, #4DD0E1);">
        <div class="app-icon">🔍</div>
        <div class="app-name">Think Deep</div>
      </div>
      <div class="app" data-app-key="adaptability" style="--app-gradient: linear-gradient(135deg, #DCE775, #C0CA33);">
        <div class="app-icon">🌱</div>
        <div class="app-name">Grow Strong</div>
      </div>
      <div class="app" data-app-key="healthyHabits" style="--app-gradient: linear-gradient(135deg, #80CBC4, #26A69A);">
        <div class="app-icon">🍏</div>
        <div class="app-name">Healthy Me!</div>
      </div>
      <div class="app" data-app-key="emotionalIntelligence" style="--app-gradient: linear-gradient(135deg, #E1BEE7, #BA68C8);">
        <div class="app-icon">❤️‍🩹</div>
        <div class="app-name">Feeling Buddy</div>
      </div>
      <div class="app" data-app-key="leadership" style="--app-gradient: linear-gradient(135deg, #FFAB91, #FF7043);">
        <div class="app-icon">👑</div>
        <div class="app-name">Leader Zone</div>
      </div>
      <div class="app" data-app-key="globalCitizenship" style="--app-gradient: linear-gradient(135deg, #CFD8DC, #78909C);">
        <div class="app-icon">🌍</div>
        <div class="app-name">My World</div>
      </div>
      <div class="app" data-app-key="digitalLiteracy" style="--app-gradient: linear-gradient(135deg, #F48FB1, #EC407A);">
        <div class="app-icon">💻</div>
        <div class="app-name">Tech Wiz</div>
      </div>
      <div class="app" data-app-key="creativity" style="--app-gradient: linear-gradient(135deg, #FFF9C4, #FFF176);">
        <div class="app-icon">🎨</div>
        <div class="app-name">Art & Imagine</div>
      </div>
      <div class="app" data-app-key="stressManagement" style="--app-gradient: linear-gradient(135deg, #B3E5FC, #4FC3F7);">
        <div class="app-icon">🧘</div>
        <div class="app-name">Calm Space</div>
      </div>
      <div class="app" data-app-key="storyteller" style="--app-gradient: linear-gradient(135deg, #A1887F, #6D4C41);">
        <div class="app-icon">📖</div>
        <div class="app-name">Storyteller</div>
      </div>
    </div>

    <div id="appContent" class="screen-overlay">
      <div class="app-content-wrapper">
        <h2 id="appTitle"></h2>
        <div id="appBody"></div>
      </div>
    </div>

    <div id="parentalGate" class="parental-gate-overlay">
      <div class="parental-gate-box">
        <h3>Daily Wisdom!</h3>
        <p id="dailyWisdomText"></p>
        <p id="dailyWisdomChallenge"></p>
        <input type="number" id="mathAnswerInput" placeholder="Your answer" style="display: none;">
        <button id="submitAnswerBtn" style="display: none;">Submit Answer</button>
        <p id="mathFeedback" class="feedback-message" style="display: none;"></p>
        <button id="understandButton">Got It!</button>
      </div>
    </div>

  </div>

  <audio id="backgroundTouchSound" src="https://assets.mixkit.co/sfx/preview/mixkit-small-group-of-kids-laughing-950.mp3" preload="auto"></audio>
  <audio id="storyAudioPlayer" preload="auto"></audio>


  <script>
    // --- Configuration & Data ---
    // !!! IMPORTANT: Replace with your actual Pexels API Key !!!
    // Get one for free at pexels.com/api/
    // If you don't use it, the Storyteller app's images will not load.
    const PEXELS_API_KEY = 'YOUR_PEXELS_API_KEY'; // Replace this!

    // Generic audio for when specific narration is not available
    const GENERIC_SUCCESS_SOUND = "https://assets.mixkit.co/sfx/preview/mixkit-positive-notification-bells-1596.mp3";

    const appData = {
      howToLive: {
        title: "Smart Choices",
        body: `
          <div class="app-content-block">
            <p><strong>Think Before You Act:</strong> Stop, think, and then choose. Good choices lead to good outcomes!</p>
          </div>
          <div class="app-content-block">
            <p><strong>Learn from Mistakes:</strong> It's okay to make mistakes. The smartest kids learn from them and try differently next time.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Ask for Help:</strong> When a choice is hard, talk to a trusted adult. They can help you decide what's best.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Be Responsible:</strong> Smart choices mean taking responsibility for your actions, whether big or small.</p>
          </div>
        `
      },
      respectFamily: {
        title: "Family Love",
        body: `
          <div class="app-content-block">
            <p><strong>Listen & Share:</strong> Share your day and listen to your family's stories. Family time is precious!</p>
          </div>
          <div class="app-content-block">
            <p><strong>Help Around the Home:</strong> Chores are teamwork! Help keep your home happy and tidy.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Show Appreciation:</strong> A "thank you" or a hug can make someone's day. Show your family you care.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Solve Problems Together:</strong> If there's a disagreement, talk it out calmly and find a solution together.</p>
          </div>
        `
      },
      careSiblings: {
        title: "Teamwork",
        body: `
          <div class="app-content-block">
            <p><strong>Share & Play Fair:</strong> Toys, games, and even attention! Sharing makes everything more fun.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Help Each Other:</strong> If a sibling needs help with homework or a tricky game, offer a hand!</p>
          </div>
          <div class="app-content-block">
            <p><strong>Kind Words Win:</strong> Choose kind words and gentle actions. Being a good teammate makes everyone happy.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Celebrate Together:</strong> Cheer for your siblings' successes, big or small. You're a team!</p>
          </div>
        `
      },
      beSelf: {
        title: "Be Yourself!",
        body: `
          <div class="app-content-block">
            <p><strong>You are Unique:</strong> There's only one you! Embrace your special talents, ideas, and personality.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Trust Your Gut:</strong> Listen to your inner voice. It often knows what's right for you.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Shine Bright:</strong> Don't be afraid to show who you are, even if it's different from others. Your uniqueness is your strength!</p>
          </div>
          <div class="app-content-block">
            <p><strong>Grow Every Day:</strong> Being yourself also means always trying to be a better version of yourself, learning and growing.</p>
          </div>
        `
      },
      loveOthers: {
        title: "Kindness Map",
        body: `
          <div class="app-content-block">
            <p><strong>Smiling Spreads Joy:</strong> A simple smile can brighten someone's day. Try it!</p>
          </div>
          <div class="app-content-block">
            <p><strong>Help a Friend:</strong> If you see someone sad or needing help, offer support. Big hearts make a big difference.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Share Your Kindness:</strong> Share a snack, a toy, or a kind word. Sharing shows you care.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Forgive and Move On:</strong> If someone makes a mistake, try to forgive them. It helps everyone feel better.</p>
          </div>
        `
      },
      // New Apps for Future Success
      goalSetting: {
        title: "My Goals",
        body: `
          <div class="app-content-block">
            <p><strong>Set Small Goals:</strong> Want to learn to read? Start with one new word a day!</p>
          </div>
          <div class="app-content-block">
            <p><strong>Dream Big!</strong> What do you want to be or do? Write it down or draw a picture!</p>
          </div>
          <div class="app-content-block">
            <p><strong>Work Hard, Play Hard:</strong> Working towards your goals makes achieving them even more rewarding!</p>
          </div>
          <div class="app-content-block">
            <p><strong>Celebrate Steps:</strong> Every little step forward is a victory! Celebrate your progress.</p>
          </div>
        `
      },
      problemSolving: {
        title: "Brain Solver",
        body: `
          <div class="app-content-block">
            <p><strong>Identify the Problem:</strong> What's the challenge? Is your tower falling? Is a friend sad?</p>
          </div>
          <div class="app-content-block">
            <p><strong>Brainstorm Ideas:</strong> Think of many ways to fix it, even silly ones! The more ideas, the better.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Choose the Best Plan:</strong> Pick the idea that seems safest and most helpful. Try it!</p>
          </div>
          <div class="app-content-block">
            <p><strong>Learn & Adapt:</strong> If it doesn't work, that's okay! Try another idea. You're getting smarter!</p>
          </div>
        `
      },
      innovation: {
        title: "Innovate Lab",
        body: `
          <div class="app-content-block">
            <p><strong>Ask "What if?":</strong> How can we make things better, faster, or more fun? Imagine new possibilities!</p>
          </div>
          <div class="app-content-block">
            <p><strong>Experiment & Create:</strong> Don't be afraid to try new things, even if they don't work perfectly the first time.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Build Your Ideas:</strong> Use blocks, drawings, or even just your words to bring your inventions to life!</p>
          </div>
          <div class="app-content-block">
            <p><strong>Share & Get Feedback:</strong> Show your creations to others and ask what they think. Their ideas might spark new ones!</p>
          </div>
        `
      },
      financialLiteracy: {
        title: "Money Smart",
        body: `
          <div class="app-content-block">
            <p><strong>Save Your Pennies:</strong> Put some money aside for something special you really want. Patience pays off!</p>
          </div>
          <div class="app-content-block">
            <p><strong>Understand Needs vs. Wants:</strong> Do you *need* that toy, or do you just *want* it? Learning the difference helps you choose wisely.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Earning is Fun:</strong> Help with chores or do small tasks to earn a bit of pocket money. It teaches you about work!</p>
          </div>
          <div class="app-content-block">
            <p><strong>Sharing is Caring:</strong> Think about donating some of your money to a cause you care about. Helping others feels good!</p>
          </div>
        `
      },
      communication: {
        title: "Talk It Up!",
        body: `
          <div class="app-content-block">
            <p><strong>Listen Closely:</strong> Give others your full attention when they speak. It shows respect and helps you understand.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Speak Clearly:</strong> Use words that others can understand and speak in a kind voice.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Express Your Feelings:</strong> It's good to talk about how you feel. Use "I feel..." statements like "I feel sad when..."</p>
          </div>
          <div class="app-content-block">
            <p><strong>Ask Questions:</strong> If you don't understand something, ask! It's how we learn and connect.</p>
          </div>
        `
      },
      criticalThinking: {
        title: "Think Deep",
        body: `
          <div class="app-content-block">
            <p><strong>Ask "Why?":</strong> Don't just accept information. Ask why things happen or why someone believes something.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Look for Proof:</strong> How do you know something is true? Is it from a reliable source or just a guess?</p>
          </div>
          <div class="app-content-block">
            <p><strong>Compare Ideas:</strong> Are there different ways to look at something? Consider all sides before deciding.</p>
          <div class="app-content-block">
            <p><strong>Connect the Dots:</strong> How do different pieces of information fit together? Can you find a pattern?</p>
          </div>
        `
      },
      adaptability: {
        title: "Grow Strong",
        body: `
          <div class="app-content-block">
            <p><strong>Change is Okay:</strong> Sometimes plans change, or new situations arise. Be ready to adjust and try new ways!</p>
          </div>
          <div class="app-content-block">
            <p><strong>Bounce Back:</strong> If something doesn't go your way, don't get stuck. Learn from it and find a new path.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Be Flexible:</strong> Like a willow tree, bend so you don't break! Flexibility helps you handle new challenges.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Embrace Newness:</strong> New friends, new schools, new games – see them as exciting adventures!</p>
          </div>
        `
      },
      healthyHabits: {
        title: "Healthy Me!",
        body: `
          <div class="app-content-block">
            <p><strong>Eat Your Colors:</strong> Eat a rainbow of fruits and veggies every day for super energy!</p>
          </div>
          <div class="app-content-block">
            <p><strong>Sleep Power:</strong> Getting enough sleep (9-11 hours!) helps your brain grow and your body feel strong!</p>
          </div>
          <div class="app-content-block">
            <p><strong>Move & Play:</strong> Run, jump, skip, and dance! Moving your body is great fun and keeps you healthy.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Clean Hands, Happy You:</strong> Wash your hands with soap and water to keep germs away and stay healthy!</p>
          </div>
        `
      },
      emotionalIntelligence: {
        title: "Feeling Buddy",
        body: `
          <div class="app-content-block">
            <p><strong>Name Your Feelings:</strong> Are you happy, sad, angry, or scared? It's good to know what you're feeling.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Understand Others:</strong> Try to see how your friends or family are feeling. Can you tell if they're happy or worried?</p>
          </div>
          <div class="app-content-block">
            <p><strong>Manage Big Feelings:</strong> If you feel angry, try taking a deep breath or counting to ten. It helps calm you down.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Show Care:</strong> If a friend is sad, a kind word or a hug can make a big difference.</p>
          </div>
        `
      },
      leadership: {
        title: "Leader Zone",
        body: `
          <div class="app-content-block">
            <p><strong>Be a Good Example:</strong> Show others how to be kind, brave, and hardworking through your own actions.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Help Others Shine:</strong> A true leader helps everyone in the group do their best, not just themselves.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Speak Up for What's Right:</b> If you see something unfair, be brave and speak up. That's true leadership!</p>
          </div>
          <div class="app-content-block">
            <p><strong>Listen to Everyone:</strong> Great leaders listen to all ideas, even if they're different from their own.</p>
          </div>
        `
      },
      globalCitizenship: {
        title: "My World",
        body: `
          <div class="app-content-block">
            <p><strong>Learn About Cultures:</strong> The world is full of amazing people, foods, and traditions! Explore and learn.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Care for Our Planet:</strong> Recycle, save water, and don't litter. We all share this beautiful Earth!</p>
          </div>
          <div class="app-content-block">
            <p><strong>Help Those in Need:</strong> Think about ways to help kids and families around the world who might need support.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Respect Everyone:</strong> No matter where people come from or what they look like, treat everyone with kindness and respect.</p>
          </div>
        `
      },
      digitalLiteracy: {
        title: "Tech Wiz",
        body: `
          <div class="app-content-block">
            <p><strong>Safe Surfing:</strong> Always ask a grown-up before going online and never share personal information.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Be a Digital Friend:</strong> Use kind words and respect others when you communicate online.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Create, Don't Just Consume:</strong> Use technology to draw, write stories, or build games, not just watch!</p>
          </div>
          <div class="app-content-block">
            <p><strong>Screen Time Balance:</strong> Enjoy screens, but also make time for outdoor play, reading, and family time.</p>
          </div>
        `
      },
      creativity: {
        title: "Art & Imagine",
        body: `
          <div class="app-content-block">
            <p><strong>Draw Your Dreams:</strong> What's in your imagination? Get it onto paper, a tablet, or even with clay!</p>
          </div>
          <div class="app-content-block">
            <p><strong>Tell Amazing Stories:</strong> Invent characters, build worlds, and share your adventures with words or pictures.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Music & Movement:</strong> Dance, sing, or make up new tunes. Let your body and voice be creative!</p>
          </div>
          <div class="app-content-block">
            <p><strong>Play Pretend:</b> Being creative isn't just about art; it's about imagining new possibilities and roles!</p>
          </div>
        `
      },
      stressManagement: {
        title: "Calm Space",
        body: `
          <div class="app-content-block">
            <p><strong>Deep Breaths:</strong> When you feel worried, take three slow, deep breaths. Inhale through your nose, exhale through your mouth.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Talk About It:</strong> Share your worries with a parent, teacher, or trusted friend. Talking helps!</p>
          </div>
          <div class="app-content-block">
            <p><strong>Move Your Body:</strong> Go for a run, jump, or play outside. Exercise helps your body feel calm.</p>
          </div>
          <div class="app-content-block">
            <p><strong>Find Your Happy Place:</strong> Think of a peaceful place or do an activity you love, like reading or drawing.</p>
          </div>
        `
      },
      // --- New Content for Audio-Visual Storyteller ---
      storyteller: {
        title: "Audio-Visual Adventures",
        content: [
          {
            text: "Hello, little friend! Are you ready for a fun story?",
            keyword: "child happy play", // For image search
            audioSrc: GENERIC_SUCCESS_SOUND // Placeholder, replace with actual narration
          },
          {
            text: "Learning to share makes everyone happy!",
            keyword: "kids sharing toys",
            audioSrc: GENERIC_SUCCESS_SOUND
          },
          {
            text: "Being kind means helping others, even with small things.",
            keyword: "child helping friend",
            audioSrc: GENERIC_SUCCESS_SOUND
          },
          {
            text: "Try new things! You might discover something amazing.",
            keyword: "child exploring new",
            audioSrc: GENERIC_SUCCESS_SOUND
          },
          {
            text: "Your feelings are important. It's okay to feel sad or mad, and it's good to talk about it.",
            keyword: "child talking feelings",
            audioSrc: GENERIC_SUCCESS_SOUND
          },
          {
            text: "Eating healthy foods gives you super energy to play all day!",
            keyword: "child eating fruit healthy",
            audioSrc: GENERIC_SUCCESS_SOUND
          },
          {
            text: "Good listening helps you learn new things and be a great friend.",
            keyword: "child listening carefully",
            audioSrc: GENERIC_SUCCESS_SOUND
          },
          {
            text: "Always remember to say please and thank you!",
            keyword: "child saying thank you",
            audioSrc: GENERIC_SUCCESS_SOUND
          },
          {
            text: "Being brave means trying something even if you're a little bit scared.",
            keyword: "child brave adventure",
            audioSrc: GENERIC_SUCCESS_SOUND
          },
          {
            text: "Your imagination is a wonderful place. What can you create today?",
            keyword: "child imagining drawing",
            audioSrc: GENERIC_SUCCESS_SOUND
          }
        ],
        getBody: function() {
          // This function will be called when the Storyteller app opens.
          // It needs to return the HTML for the story content, including image, text, and controls.
          return `
            <div class="story-content-container">
              <div class="image-loading-spinner" id="imageLoadingSpinner"></div>
              <img id="storyImage" src="" alt="Story visual" class="story-image" style="display:none;">
              <p id="storyText" class="story-text-container"></p>
              <div class="story-controls">
                <button id="prevStoryBtn">⬅️</button>
                <button id="playStoryBtn" class="play-button">🔊</button>
                <button id="nextStoryBtn">➡️</button>
              </div>
            </div>
          `;
        }
      },
      // --- Daily Wisdom Content for the Exit Gate ---
      dailyWisdom: [
        {
          type: "quote",
          text: "The best way to find yourself is to lose yourself in the service of others.",
          challenge: "How can you help someone today?",
          source: "Mahatma Gandhi"
        },
        {
          type: "value",
          text: "Kindness is like a boomerang; it always comes back to you.",
          challenge: "Who can you be extra kind to right now?",
          keywords: "kindness, sharing, giving"
        },
        {
          type: "respect",
          text: "Respect means listening carefully even when someone has different ideas.",
          challenge: "Can you practice listening with your ears and your heart?",
          keywords: "listening, respect, understanding"
        },
        {
          type: "life_hack",
          text: "A tidy space makes a tidy mind! Helping to clean up makes you feel good.",
          challenge: "What one thing can you put away before you go?",
          keywords: "tidiness, responsibility, chores"
        },
        {
          type: "quote",
          text: "The only limit to our realization of tomorrow will be our doubts of today.",
          challenge: "Believe in yourself and what you can do!",
          source: "Franklin D. Roosevelt"
        },
        {
          type: "value",
          text: "Courage is not the absence of fear, but the triumph over it.",
          challenge: "What little bravery can you show today?",
          keywords: "courage, bravery, overcoming fear"
        },
        {
          type: "respect",
          text: "Treat everyone with a smile and a kind word, just as you'd like to be treated.",
          challenge: "Who can you greet with a warm smile?",
          keywords: "manners, politeness, friendly"
        },
        {
          type: "life_hack",
          text: "When you share your toys, you can get more friends to play with!",
          challenge: "Is there a toy you can share with someone?",
          keywords: "sharing, friendship, play"
        },
        {
          type: "quote",
          text: "Be the change that you wish to see in the world.",
          challenge: "How can you make a positive difference today?",
          source: "Mahatma Gandhi"
        },
        {
          type: "value",
          text: "Honesty is telling the truth, even when it's hard.",
          challenge: "Can you always be honest with your words and actions?",
          keywords: "honesty, truth, integrity"
        },
        {
          type: "respect",
          text: "Every person is special and unique. Celebrate what makes each of us different!",
          challenge: "Can you find something special about someone near you?",
          keywords: "diversity, acceptance, unique"
        },
        {
          type: "life_hack",
          text: "A good night's sleep makes you strong, smart, and ready for adventure!",
          challenge: "Will you go to bed on time tonight?",
          keywords: "sleep, healthy habits, energy"
        },
        {
          type: "value",
          text: "Patience helps you wait for good things, like a seed waiting to grow into a flower.",
          challenge: "Can you be patient with something today?",
          keywords: "patience, waiting, growing"
        },
        {
          type: "respect",
          text: "Using polite words like 'please' and 'thank you' shows you respect others.",
          challenge: "Remember to use your magic words!",
          keywords: "politeness, manners, appreciation"
        },
        // --- New Math Problems ---
        {
          type: "math",
          text: "What is 5 + 3?",
          challenge: "Type your answer below:",
          correctAnswer: 8
        },
        {
          type: "math",
          text: "If you have 10 apples and eat 2, how many are left?",
          challenge: "Type your answer below:",
          correctAnswer: 8
        },
        {
          type: "math",
          text: "What comes after the number 12?",
          challenge: "Type your answer below:",
          correctAnswer: 13
        },
        {
          type: "math",
          text: "Count by 2s: 2, 4, 6, ____",
          challenge: "Type your answer below:",
          correctAnswer: 8
        },
        {
          type: "math",
          text: "What is 7 minus 4?",
          challenge: "Type your answer below:",
          correctAnswer: 3
        }
      ]
    };

    const backgroundTouchSound = document.getElementById('backgroundTouchSound');
    const storyAudioPlayer = document.getElementById('storyAudioPlayer');
    const splashScreen = document.getElementById('splashScreen');
    const appGrid = document.getElementById('appGrid');
    const appContent = document.getElementById('appContent');
    const appIcons = document.querySelectorAll('.app');
    const currentTimeDateSpan = document.getElementById('currentTimeDate');
    const emotionMeter = document.getElementById('emotionMeter'); // New emotion meter element

    // Parental Gate Elements (now Daily Wisdom Gate)
    const parentalGate = document.getElementById('parentalGate');
    const dailyWisdomText = document.getElementById('dailyWisdomText');
    const dailyWisdomChallenge = document.getElementById('dailyWisdomChallenge');
    const understandButton = document.getElementById('understandButton'); // This is the "Got It!" button
    const mathAnswerInput = document.getElementById('mathAnswerInput');
    const submitAnswerBtn = document.getElementById('submitAnswerBtn');
    const mathFeedback = document.getElementById('mathFeedback');


    // Storyteller app specific variables
    let currentStoryIndex = 0;
    let shuffledStoryContent = [];
    let imageCache = {}; // To store fetched image URLs to avoid refetching
    let lastDailyWisdomIndex = -1; // To avoid immediate repetition of wisdom

    // --- Utility Functions ---

    // Function to update real-time clock and date
    function updateTimeAndDate() {
      const now = new Date();
      const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: true };
      const dateOptions = { month: 'short', day: 'numeric' };
      const timeString = now.toLocaleTimeString('en-US', timeOptions);
      const dateString = now.toLocaleDateString('en-US', dateOptions);
      currentTimeDateSpan.textContent = `${timeString} ${dateString}`;
    }

    // Function to update the emotion meter
    // For simplicity, we'll keep it static happy here, but it can be changed.
    function updateEmotionMeter(emotion = 'happy') {
      let emoji = '😊'; // Default happy
      if (emotion === 'thoughtful') emoji = '🤔';
      else if (emotion === 'calm') emoji = '😌';
      else if (emotion === 'excited') emoji = '🤩';
      else if (emotion === 'neutral') emoji = '🙂';

      emotionMeter.textContent = emoji;
    }

    // Initial updates
    updateTimeAndDate();
    updateEmotionMeter('happy'); // Set initial mood
    setInterval(updateTimeAndDate, 1000);

    // --- Daily Wisdom Gate Logic ---
    function showParentalGate() {
      // Hide math specific elements initially
      mathAnswerInput.style.display = 'none';
      submitAnswerBtn.style.display = 'none';
      mathFeedback.style.display = 'none';
      understandButton.style.display = 'block'; // Ensure "Got It!" is visible by default

      // Pick a random wisdom from the pool, ensuring it's not the same as last time
      let randomIndex;
      do {
        randomIndex = Math.floor(Math.random() * appData.dailyWisdom.length);
      } while (randomIndex === lastDailyWisdomIndex && appData.dailyWisdom.length > 1);

      lastDailyWisdomIndex = randomIndex;
      const wisdom = appData.dailyWisdom[randomIndex];

      dailyWisdomText.textContent = wisdom.text;
      dailyWisdomChallenge.textContent = wisdom.challenge;

      // Store the current wisdom object to access its type and answer later
      parentalGate.dataset.currentWisdomType = wisdom.type;

      if (wisdom.type === 'math') {
        parentalGate.dataset.correctMathAnswer = wisdom.correctAnswer; // Store correct answer
        mathAnswerInput.value = ''; // Clear previous input
        mathAnswerInput.style.display = 'block';
        submitAnswerBtn.style.display = 'block';
        understandButton.style.display = 'none'; // Hide "Got It!" for math problems
        mathAnswerInput.focus(); // Focus on the input field
      } else {
        // For non-math types, ensure math elements are hidden and "Got It!" is visible
        mathAnswerInput.style.display = 'none';
        submitAnswerBtn.style.display = 'none';
        mathFeedback.style.display = 'none';
        understandButton.style.display = 'block';
      }

      parentalGate.classList.add('visible');
      updateEmotionMeter('thoughtful'); // Mood changes when gate appears
    }

    // Event listener for the main "Got It!" button
    understandButton.addEventListener('click', () => {
      parentalGate.classList.remove('visible');
      reallyCloseApp();
      updateEmotionMeter('happy'); // Mood returns to happy after wisdom
    });

    // Event listener for the new "Submit Answer" button
    submitAnswerBtn.addEventListener('click', () => {
      const userAnswer = parseInt(mathAnswerInput.value);
      const correctAnswer = parseInt(parentalGate.dataset.correctMathAnswer);

      if (userAnswer === correctAnswer) {
        mathFeedback.textContent = "Correct! Great job!";
        mathFeedback.classList.add('correct');
        mathFeedback.style.display = 'block';
        mathAnswerInput.style.display = 'none';
        submitAnswerBtn.style.display = 'none';
        understandButton.style.display = 'block'; // Show "Got It!" button to close
      } else {
        mathFeedback.textContent = "Oops! That's not quite right. Try again!";
        mathFeedback.classList.remove('correct');
        mathFeedback.style.display = 'block';
        mathAnswerInput.value = ''; // Clear input for retry
        mathAnswerInput.focus();
      }
    });


    // --- App Navigation Logic ---

    // Splash Screen click handler
    splashScreen.addEventListener('click', () => {
      backgroundTouchSound.currentTime = 0;
      backgroundTouchSound.play().catch(e => console.log("Audio play prevented:", e));
      splashScreen.classList.add('hidden');
      setTimeout(() => {
        splashScreen.style.display = 'none';
      }, 500);
      appGrid.style.display = 'grid';
      appGrid.classList.remove('hidden');
      updateEmotionMeter('excited'); // Mood becomes excited when entering main grid
    });

    // Handle opening apps
    appIcons.forEach(app => {
      app.addEventListener('click', (e) => {
        const appKey = app.dataset.appKey;
        openApp(appKey);

        const ripple = document.createElement('span');
        ripple.classList.add('ripple');
        const rect = app.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size / 2;
        const y = e.clientY - rect.top - size / 2;
        ripple.style.width = ripple.style.height = `${size}px`;
        ripple.style.left = `${x}px`;
        ripple.style.top = `${y}px`;
        app.appendChild(ripple);

        ripple.addEventListener('animationend', () => {
          ripple.remove();
        });
      });
    });

    function openApp(key) {
      const app = appData[key];
      if (!app) {
        console.error("App data not found for key:", key);
        return;
      }

      document.getElementById("appTitle").innerText = app.title;

      if (key === 'storyteller') {
        document.getElementById("appBody").innerHTML = app.getBody();
        initializeStoryteller(); // Initialize storyteller specific elements
      } else {
        document.getElementById("appBody").innerHTML = app.body;
      }

      appGrid.classList.add('hidden');
      appContent.style.display = 'flex';
      setTimeout(() => {
        appContent.classList.add('visible');
        document.querySelector('.app-content-wrapper').scrollTop = 0;
        backgroundTouchSound.currentTime = 0;
        backgroundTouchSound.play().catch(e => console.log("Audio play prevented:", e));
        updateEmotionMeter('happy'); // Mood happy when inside an app
      }, 0);
    }

    appContent.addEventListener('click', (event) => {
      const clickedOnContentBlock = event.target.closest('.app-content-block');
      const clickedOnWrapper = event.target.closest('.app-content-wrapper');
      const clickedOnTitle = event.target === document.getElementById('appTitle');

      // Do not trigger parental gate if clicking inside a storyteller content (handled by specific buttons)
      // or if it's a regular text-based content block.
      // The original logic `(clickedOnWrapper && !clickedOnContentBlock)` means clicks anywhere
      // within the wrapper *unless* it's specifically a content block.
      // This allows clicking the general background of the app window to close it.
      if (!event.target.closest('.story-content-container') &&
          (event.target === appContent || (clickedOnWrapper && !clickedOnContentBlock) || clickedOnTitle)) {
        showParentalGate();
      }
    });


    function reallyCloseApp() {
      // Stop any ongoing audio before closing
      storyAudioPlayer.pause();
      storyAudioPlayer.currentTime = 0;

      appContent.classList.remove('visible');
      setTimeout(() => {
        appContent.style.display = 'none';
        appGrid.style.display = 'grid';
        appGrid.classList.remove('hidden');
        backgroundTouchSound.currentTime = 0;
        backgroundTouchSound.play().catch(e => console.log("Audio play prevented:", e));
      }, 400);
    }

    // --- Back button handling for PWAs ---
    // This is crucial for PWA feel.
    window.addEventListener('popstate', (event) => {
      // If an app is open and the parental gate is NOT visible, show the gate.
      if (appContent.classList.contains('visible') && !parentalGate.classList.contains('visible')) {
        showParentalGate();
        // Push a new state so that the back button action doesn't immediately exit the PWA
        // after the gate is shown. This keeps the gate as the "back" target.
        history.pushState(null, null, document.URL);
      }
      // If the parental gate IS visible, just hide it and stay on the current app.
      // This means a second back press will close the app.
      else if (parentalGate.classList.contains('visible')) {
        parentalGate.classList.remove('visible');
        updateEmotionMeter('happy'); // Mood returns to happy when gate is dismissed
        history.pushState(null, null, document.URL); // Keep app open in history
      }
      // If we are on the app grid or splash, allow the browser's default back action.
      // This will typically exit the PWA or go to the previous browser history entry.
      else {
        console.log("On app grid or splash, allowing browser back action (to exit PWA or go to previous page).");
      }
    });

    // On initial load, push a state to ensure 'popstate' always has something to go back to within the app.
    // This makes the first back button press always handled by our logic.
    window.onload = () => {
      if (history.state === null) {
        history.pushState(null, null, document.URL);
      }
    };


    // --- Audio-Visual Storyteller Logic ---

    async function fetchImage(keyword) {
      if (!PEXELS_API_KEY || PEXELS_API_KEY === 'YOUR_PEXELS_API_KEY') {
        console.warn("Pexels API Key is not set. Images will not load dynamically for the Storyteller app. Please obtain a key from pexels.com/api/ and replace 'YOUR_PEXELS_API_KEY' in the code.");
        return null; // Return null if API key is missing
      }

      // Check cache first
      if (imageCache[keyword]) {
        return imageCache[keyword];
      }

      const spinner = document.getElementById('imageLoadingSpinner');
      const storyImage = document.getElementById('storyImage');
      storyImage.style.display = 'none'; // Hide image while loading
      spinner.style.display = 'block'; // Show spinner

      try {
        const response = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(keyword)}&per_page=1&orientation=landscape`, {
          headers: {
            Authorization: PEXELS_API_KEY
          }
        });

        if (!response.ok) {
          throw new Error(`Pexels API error: ${response.statusText} (Status: ${response.status})`);
        }

        const data = await response.json();
        if (data.photos && data.photos.length > 0) {
          const imageUrl = data.photos[0].src.medium; // Use medium size for efficiency
          imageCache[keyword] = imageUrl; // Cache the image URL
          return imageUrl;
        } else {
          console.warn(`No images found on Pexels for keyword: "${keyword}"`);
        }
      } catch (error) {
        console.error("Failed to fetch image from Pexels:", error);
      } finally {
        spinner.style.display = 'none'; // Hide spinner
      }
      return null; // Return null if no image is found or an error occurs
    }

    async function displayStoryContent() {
      const storyImage = document.getElementById('storyImage');
      const storyText = document.getElementById('storyText');
      const playStoryBtn = document.getElementById('playStoryBtn');
      const currentContent = shuffledStoryContent[currentStoryIndex];

      if (!currentContent) {
        console.warn("No story content to display. Reshuffling for next round.");
        // If all content has been shown, reshuffle for next round
        shuffledStoryContent = shuffleArray([...appData.storyteller.content]);
        currentStoryIndex = 0;
        // Recursive call with a small delay to prevent stack overflow if content is empty
        setTimeout(() => displayStoryContent(), 50);
        return;
      }

      storyText.textContent = currentContent.text;
      storyAudioPlayer.src = currentContent.audioSrc || GENERIC_SUCCESS_SOUND; // Use generic sound if not specified

      // Fetch and display image
      const imageUrl = await fetchImage(currentContent.keyword);
      if (imageUrl) {
        storyImage.src = imageUrl;
        storyImage.onload = () => {
          storyImage.style.display = 'block'; // Show image once loaded
        };
        storyImage.onerror = () => {
          storyImage.style.display = 'none'; // Hide image if it fails to load
          console.warn("Failed to load image from URL:", imageUrl);
        };
      } else {
        storyImage.style.display = 'none'; // Hide image if no URL is found
      }

      playStoryBtn.textContent = '�'; // Reset to play icon
      storyAudioPlayer.pause();
      storyAudioPlayer.currentTime = 0;
    }

    function playCurrentStoryAudio() {
      storyAudioPlayer.play().catch(e => console.log("Audio play prevented:", e));
      // Optionally, change play button to pause/stop icon while playing
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function initializeStoryteller() {
      // Shuffle content when the storyteller app is opened
      shuffledStoryContent = shuffleArray([...appData.storyteller.content]);
      currentStoryIndex = 0; // Start from the first shuffled item

      const prevStoryBtn = document.getElementById('prevStoryBtn');
      const nextStoryBtn = document.getElementById('nextStoryBtn');
      const playStoryBtn = document.getElementById('playStoryBtn');

      if (prevStoryBtn && nextStoryBtn && playStoryBtn) {
        prevStoryBtn.onclick = () => {
          currentStoryIndex = (currentStoryIndex - 1 + shuffledStoryContent.length) % shuffledStoryContent.length;
          displayStoryContent();
        };
        nextStoryBtn.onclick = () => {
          currentStoryIndex = (currentStoryIndex + 1) % shuffledStoryContent.length;
          displayStoryContent();
        };
        playStoryBtn.onclick = playCurrentStoryAudio;

        // Display the first piece of content
        displayStoryContent();
      } else {
        console.error("Storyteller buttons not found. Check HTML structure.");
      }
    }

  </script>
</body>
</html>
